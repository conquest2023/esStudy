<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ìà¨Ìëú ÏÉÅÏÑ∏Î≥¥Í∏∞</title>

    <!-- FontAwesome, Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        .container {
            max-width: 1200px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        tr {
            border-bottom: 1px solid #ddd;
        }
        .comment-box input,
        .comment-box textarea {
            width: 100%;
            border: 1px solid #ccc;
            padding: 10px;
            font-size: 1rem;
            border-radius: 5px;
            background: #f5f5f5;
        }
        .comment-box button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        .comment-box button:hover {
            background: #0056b3;
        }
        .comment-table th, .comment-table td {
            padding: 8px;
            text-align: left;
        }
        .comment-options a, .comment-options form {
            display:inline-block;
            margin-bottom: 5px;
        }
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        h1 {
            margin-bottom: 30px;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        h2 {
            font-size: 1.8rem;
            font-weight: bold;
            color: #333;
        }
        p {
            margin: 5px 0;
            font-size: 0.9rem;
            color: #555;
        }
        .description-box {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            font-size: 1.2rem;
            color: #333;
            width: 100%;
            max-width: 100%;
            min-height: 250px;
            word-break: break-word;
            margin-top: 15px;
            line-height: 1.6;
        }
        .like-comment-box {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }
        .like-comment-box .fa-comment {
            color: #007bff;
        }
        /* Ï¢ãÏïÑÏöî Í∏∞Îä• Ï†úÍ±∞ ‚Üí Í¥ÄÎ†® Ïä§ÌÉÄÏùº ÏÇ≠Ï†ú */
        .btn-link {
            color: #007bff;
            text-decoration: none;
        }
        .btn-link:hover {
            text-decoration: underline;
        }
        .edit-btn, .delete-btn {
            display: inline-block;
        }
        tr {
            margin-bottom: 20px;
        }
        .like-comment-box {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }
        .like-comment-box button {
            display: flex;
            align-items: center;
            gap: 5px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 1rem;
        }
        .like-comment-box button:hover {
            text-decoration: underline;
        }
        .comment-box {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            width: 100%;
            max-width: 1200px;
            background: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .comment-box input {
            flex-grow: 1;
            border: none;
            padding: 10px;
            font-size: 1rem;
            border-radius: 5px;
            background: #f5f5f5;
        }
        .comment-box button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        .comment-box button:hover {
            background: #0056b3;
        }
        .comment-content {
            text-align: left;
            margin-left: 0;
            font-size: 16px;
            color: #333;
            line-height: 1.5;
            padding-left: 0 !important;
        }
        .feed-card {
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .feed-title {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .feed-meta {
            font-size: 0.95rem;
            color: #666;
            margin-bottom: 15px;
        }
        .feed-content {
            font-size: 1.2rem;
            line-height: 1.7;
            margin-top: 15px;
        }
        .feed-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        .delete-btn-container {
            position: absolute;
            top: 10px;
            right: 10px;
        }
        .delete-feed-btn {
            background: red;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
        }
        .delete-feed-btn:hover {
            background: darkred;
        }
        .reply-toggle {
            margin-left: auto;
            display: block;
            text-align: right;
        }
        .vote-container, .vote-results-container {
            background: #1c1c1e;
            color: white;
            padding: 15px;
            border-radius: 8px;
            width: 100%;
            max-width: 400px;
            margin: auto;
        }

        .vote-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 10px;
        }

        .vote-option-btn {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            border: 2px solid #007bff;
            border-radius: 8px;
            background-color: white;
            color: #007bff;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }

        .vote-option-btn:hover {
            background-color: #007bff;
            color: white;
        }

        .vote-option-btn.active {
            background-color: #0056b3;
            color: white;
            border-color: #0056b3;
        }

        .vote-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .vote-bar {
            width: 100%;
            height: 6px;
            background: #444;
            border-radius: 3px;
            margin-top: 5px;
            position: relative;
            overflow: hidden;
        }

        .vote-bar-fill {
            height: 100%;
            background: yellow;
            position: absolute;
            left: 0;
            top: 0;
        }

    </style>
</head>
<body>
<nav id="leftSidebar" class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold text-primary me-auto custom-logo" href="/">Ninfo</a>
    </div>
</nav>
<div class="container my-4">
    <div id="voteDetailContainer"></div>
    <div id="commentSection"></div>
    <div id="commentForm"></div>

    <div class="text-center mt-4">
        <a href="/search/view/feed?index=board" class="btn btn-secondary">
            <i class="fas fa-home"></i> Î©îÏù∏ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
        </a>
    </div>
</div>
<script>
    function renderVoteDetail(jsonData, selectOptionMap) {
        const token = localStorage.getItem("token");
        const container = document.getElementById('voteDetailContainer');
        const vote = jsonData.data;
        let deleteButtonHTML = '';
        container.innerHTML = '';

        if (!vote) {
            container.innerHTML = '<p>Ìà¨Ìëú Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.</p>';
            return;
        }
        const formattedDescription = vote.description ? vote.description.replace(/\n/g, "<br>") : "";
        let badge = "";
        const rank = topWriters[vote.username] || 0;
        if (rank === 1) badge = "ü•á";
        else if (rank === 2) badge = "ü•à";
        else if (rank === 3) badge = "ü•â";
        else if (rank >= 4 && rank <= 5) badge = "üî•";

        const voteCounts = {};
        let totalVotes = 0;
        if (selectOptionMap) {
            Object.entries(selectOptionMap).forEach(([option, count]) => {
                voteCounts[option] = count;
                totalVotes += count;
            });
        }
        let voteOptionsHtml = vote.voteType.map(option =>
            `<button class="vote-option-btn" data-option="${option}">${option}</button>`
        ).join('<br>');

        let voteResultsHtml = Object.entries(voteCounts).map(([option, count]) => {
            const percentage = totalVotes > 0 ? (count / totalVotes) * 100 : 0;
            return `
            <div class="vote-option">
                <span><strong>${option}</strong> (${count}Î™Ö)</span>
                <div class="vote-bar">
                    <div class="vote-bar-fill" style="width: ${percentage}%; background-color: ${getRandomColor()};"></div>
                </div>
            </div>
        `;
        }).join('');
        if (jsonData.Owner && token) {
            deleteButtonHTML = `
            <button type="button" class="btn btn-danger delete-feed-btn" onclick="deleteVoteFeed('${vote.id}')">
                <i class="fas fa-trash"></i> ÏÇ≠Ï†úÌïòÍ∏∞
            </button>
        `;
        }
        const html = `
        <div class="card feed-card">
            <div class="card-body">
                ${deleteButtonHTML ? `<div class="text-end mb-3">${deleteButtonHTML}</div>` : ""}
                <h2 class="feed-title">${vote.title}</h2>
                <p class="feed-meta">
                    <strong>ÏûëÏÑ±Ïûê:</strong> ${badge} ${vote.username} &nbsp;|&nbsp;
                    <strong>ÏûëÏÑ±ÏùºÏûê:</strong> ${formatDate(vote.createdAt)}
                </p>
                <div class="feed-content">${formattedDescription || ""}</div>
                <div class="mt-3">
                    <h5>Ìà¨Ìëú Ìï≠Î™©</h5>
                    <div class="vote-options">${voteOptionsHtml}</div>
                </div>
                <div class="mt-3">
                    <h5>ÌòÑÏû¨ Ìà¨Ìëú Í≤∞Í≥º</h5>
                    <div class="vote-results">${voteResultsHtml}</div>
                </div>
                <div class="mt-3">
                    <p>üë• Ï¥ù Ï∞∏Ïó¨Ïûê: <strong>${totalVotes}</strong>Î™Ö</p>
                </div>
                <div class="mt-3">
                    <button class="btn btn-primary vote-submit-btn" onclick="submitVote('${vote.voteId}','${vote.title}')">Ìà¨ÌëúÌïòÍ∏∞</button>
                </div>
            </div>
        </div>
    `;

        container.innerHTML = html;

        document.querySelectorAll(".vote-option-btn").forEach(button => {
            button.addEventListener("click", function () {
                document.querySelectorAll(".vote-option-btn").forEach(btn => btn.classList.remove("active"));
                this.classList.add("active");
            });
        });
    }
    function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }
    function deleteVoteFeed(feedId) {
        const token = localStorage.getItem("token");
        if (token) {
            if (!confirm("Ï†ïÎßêÎ°ú Ïù¥ Í≤åÏãúÍ∏ÄÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
                return;
            }
            fetch(`/search/view/vote/delete`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: JSON.stringify({
                    id: feedId,
                }),
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("Í≤åÏãúÍ∏Ä ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
                    }
                    return response.json();
                })
                .then((data) => {
                    const redirectUrl = data.redirectUrl;
                    if (redirectUrl) {
                        alert("Í≤åÏãúÍ∏ÄÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.");
                        window.location.href = redirectUrl;
                    } else {
                        throw new Error("Î¶¨Îã§Ïù¥Î†âÌä∏ URLÏù¥ ÏùëÎãµÏóê ÏóÜÏäµÎãàÎã§.");
                    }
                })
                .catch((error) => {
                    console.error("ÏÇ≠Ï†ú Ï§ë Ïò§Î•ò Î∞úÏÉù:", error);
                    alert("ÏÇ≠Ï†ú Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.");
                });
        }
    }
    // function fetchVoteDetails(voteId) {
    //     const token = localStorage.getItem("token");
    //
    //     fetch(`/get/ticket/vote?id=${voteId}`, {
    //         method: "GET",
    //         headers: token ? { "Authorization": `Bearer ${token}` } : {}
    //     })
    //         .then(response => response.json())
    //         .then(data => {
    //             if (data.error) {
    //                 alert("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.");
    //                 return;
    //             }
    //             renderVoteDetail(data);
    //         })
    //         .catch(error => {
    //             console.error("Ìà¨Ìëú Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•ò Î∞úÏÉù:", error);
    //             alert("Ìà¨Ìëú Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
    //         });
    // }
    // document.addEventListener('DOMContentLoaded', function () {
    //     const urlParams = new URLSearchParams(window.location.search);
    //     const voteId = urlParams.get('id');
    //     if (!voteId) {
    //         alert("Ìà¨Ìëú IDÍ∞Ä ÏóÜÏäµÎãàÎã§.");
    //         return;
    //     }
    //     fetchVoteDetails(voteId);
    // });

    function submitVote(voteId,title) {
        const urlParams = new URLSearchParams(window.location.search);
        const selectedButton = document.querySelector(".vote-option-btn.active");
        if (!selectedButton) {
            alert("Ìà¨Ìëú Ìï≠Î™©ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
            return;
        }
        const selectedOption = selectedButton.getAttribute("data-option");
        fetch(`/save/ticket/vote`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${localStorage.getItem("token")}`
            },
            body: JSON.stringify({
                feedUID: urlParams.get('id'),
                title: title,
                selectedOption: selectedOption
            })
            })
            .then(response => response.json())
            .then(data => {
                if (data) {
                    alert("Ìà¨ÌëúÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!");
                    setTimeout(() => {
                        location.reload();
                    }, 500);
                } else {
                    alert("Ìà¨Ìëú Ï§ë Ïò§Î•ò Î∞úÏÉù: " + (data.error || "Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò"));
                }
            })
            .catch(error => {
                console.error("Ìà¨Ìëú Ï†úÏ∂ú Ï§ë Ïò§Î•ò:", error);
                alert("Ìà¨Ìëú Ï†úÏ∂ú Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
            });
    }

    function formatDate(dateTimeString) {
        if (!dateTimeString) return '';

        const date = new Date(dateTimeString);
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const day = date.getDate();
        let hour = date.getHours();
        const minute = date.getMinutes();
        const period = hour >= 12 ? 'Ïò§ÌõÑ' : 'Ïò§Ï†Ñ';
        hour = hour % 12 || 12;
        const formattedMinute = minute < 10 ? `0${minute}` : minute;
        return `${month}. ${day}. ${period} ${hour}:${formattedMinute}`;
    }

    function renderCommentForm(jsonData) {
        const commentFormDiv = document.getElementById('commentForm');
        const vote = jsonData?.data;
        const html = `
        <div class="card shadow-sm p-3">
          <div class="card-body">
            <h5><i class="fas fa-pencil-alt"></i> Write a Comment</h5>
            <input type="hidden" id="feedAuthorId"/>
            <input type="hidden" id="currentUserId" />
            <div class="form-group mt-3">
              <label for="username" class="form-label">Ïù¥Î¶Ñ</label>
              <input type="text" id="username" class="form-control" required />
              <small class="text-muted d-block mt-1">
                Î°úÍ∑∏Ïù∏ÌïòÏßÄ ÏïäÏúºÎ©¥ ÏûêÎèôÏúºÎ°ú <strong>ÏùµÎ™Ö</strong> Ï≤òÎ¶¨Îê©ÎãàÎã§.
              </small>
            </div>
            <div class="form-group mt-3">
              <label for="content" class="form-label">ÎÇ¥Ïö©</label>
              <textarea id="content" rows="4" class="form-control" required></textarea>
            </div>
            <button id="btnCommentSubmit" type="button" class="btn btn-success mt-3" onclick="submitComment()">
              <i class="fas fa-pencil-alt"></i> ÏûëÏÑ±ÌïòÍ∏∞
            </button>
          </div>
        </div>
      `;
        commentFormDiv.innerHTML = html;
    }

    function renderCommentSection(jsonData) {
        const commentContainer = document.getElementById('commentSection');
        commentContainer.innerHTML = '';
        const comments = jsonData.comment;
        const replies = jsonData.replies;

        if (!comments || comments.length === 0) {
            commentContainer.innerHTML = '<p>ÎåìÍ∏ÄÏù¥ ÏóÜÏäµÎãàÎã§.</p>';
            return;
        }
        let html = `<h5 class="mt-4"><i class="fas fa-comments"></i> Comments</h5>`;
        comments.forEach((cmt) => {
            let rank = topWriters[cmt.username] || 0;
            let badge = rank === 1 ? "ü•á" : rank === 2 ? "ü•à" : rank === 3 ? "ü•â" : rank >= 4 && rank <= 5 ? "üî•" : "";
            const displayedUsername = cmt.author
                ? `<strong style="color:#888;">${badge}ÏûëÏÑ±Ïûê(${cmt.username})</strong>`
                : `<strong>${badge} ${cmt.username}</strong>`;
            html += `
          <div class="border-bottom pb-3 mb-3" id="comment-${cmt.commentUID}">
              <div class="d-flex justify-content-between align-items-center">
                  <div>
                      ${displayedUsername}
                      <small class="text-muted ms-2">${formatDate(cmt.createdAt)}</small>
                  </div>
                  <div>
                      ${cmt.commentOwner ? `
                          <button class="btn btn-sm btn-link text-secondary edit-comment-btn" data-comment-id="${cmt.commentUID}">ÏàòÏ†ï</button>
                          <button class="btn btn-sm btn-link text-danger delete-comment-btn" data-comment-id="${cmt.commentUID}">ÏÇ≠Ï†ú</button>
                      ` : ""}
                  </div>
              </div>
              <div id="comment-content-${cmt.commentUID}" style="white-space:pre-wrap; text-align: left;">
                  ${convertLinks(cmt.content)}
              </div>
              <div class="mt-3 ms-3">
                  ${renderReplies(replies[cmt.commentUID] || [])}
                  <button class="btn btn-sm btn-outline-primary reply-toggle" data-comment-id="${cmt.commentUID}">ÎãµÍ∏Ä Îã¨Í∏∞</button>
                  <div class="reply-form mt-2" id="reply-form-${cmt.commentUID}" style="display:none;">
                      <textarea class="form-control mb-2" rows="2" placeholder="ÎãµÍ∏Ä ÏûëÏÑ±..."></textarea>
                      <button class="btn btn-sm btn-primary submit-reply-btn" data-comment-id="${cmt.commentUID}">ÎãµÍ∏Ä ÏûëÏÑ±</button>
                  </div>
              </div>
          </div>`;
        });
        commentContainer.innerHTML = html;
        comments.forEach((cmt) => {
            const commentElement = document.getElementById(`comment-content-${cmt.commentUID}`);
            if (commentElement) {
                commentElement.innerHTML = convertLinks(cmt.content);
            }
        });
        initializeCommentEvents(jsonData.feedUID);
    }

    function convertLinks(text) {
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        return text.replace(urlRegex, url => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`);
    }

    let topWriters = {};

    function fetchTopWriters() {
        let cachedData = localStorage.getItem("topWriters");
        let cachedTime = localStorage.getItem("topWritersTimestamp");
        if (cachedData && cachedTime && (Date.now() - cachedTime) < 3600000) {
            console.log("Ï∫êÏã±Îêú Top Writers ÏÇ¨Ïö©");
            topWriters = JSON.parse(cachedData);
            return Promise.resolve(topWriters);
        }
        return fetch("/top-writers")
            .then(response => response.json())
            .then(data => {
                topWriters = {};
                data.forEach((writer, index) => {
                    topWriters[writer.username] = index + 1;
                });
                console.log("ÏÉàÎ°ú Í∞ÄÏ†∏Ïò® TopWriters:", topWriters);
                localStorage.setItem("topWriters", JSON.stringify(topWriters));
                localStorage.setItem("topWritersTimestamp", Date.now());
                return topWriters;
            })
            .catch(error => {
                console.error("Top Ïú†Ï†Ä Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®:", error);
                return {};
            });
    }

    document.addEventListener('DOMContentLoaded', async function () {
        const urlParams = new URLSearchParams(window.location.search);
        const voteId = urlParams.get('id');
        if (!voteId) {
            alert("Ìà¨Ìëú IDÍ∞Ä ÏóÜÏäµÎãàÎã§.");
            return;
        }

        try {
            const token = localStorage.getItem("token");
            const headers = { "Content-Type": "application/json" };
            if (token) {
                headers["Authorization"] = `Bearer ${token}`;
            }
            const [voteDetailResponse, voteStatusResponse] = await Promise.all([
                fetch(`/vote/detail?id=${voteId}`, { method: "GET", headers }),
                token ? fetch(`/get/ticket/vote?id=${voteId}`, { method: "GET", headers }) : null
            ]);


            const voteDetailData = await voteDetailResponse.json();
            const voteStatusData = voteStatusResponse ? await voteStatusResponse.json() :
                { hasVoted: false, selectOption: {} };

            renderVoteDetail(voteDetailData, voteStatusData.selectOption);

            renderCommentSection(voteDetailData);
            renderCommentForm(voteDetailData);
            applyVoteStatus(voteStatusData.hasVoted, voteStatusData.selectOption);

            const usernameInput = document.getElementById("username");
            if (usernameInput) {
                usernameInput.value = voteDetailData.username;
                usernameInput.setAttribute("readonly", true);
            }

        } catch (error) {
            console.error("Ìà¨Ìëú Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•ò Î∞úÏÉù:", error);
            alert("Ìà¨Ìëú Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
        }
    });
    function applyVoteStatus(hasVoted, selectOptionMap) {
        if (hasVoted) {
            document.querySelector(".vote-submit-btn").style.display = "none";

            const selectedOptions = Object.keys(selectOptionMap).filter(option => option !== "null");

            document.querySelectorAll(".vote-option-btn").forEach(button => {
                const buttonOption = button.dataset.option;
                if (selectedOptions.includes(buttonOption)) {
                    button.classList.add("btn-success");
                }
            });
        }
    }
    let debounceTimeout;
    function submitComment() {
        if (debounceTimeout) clearTimeout(debounceTimeout);

        const submitButton = document.getElementById("submitCommentBtn");
        if (submitButton) {
            submitButton.disabled = true;
        }

        debounceTimeout = setTimeout(() => {
            const content = document.getElementById("content").value.trim();
            const username = document.getElementById("username").value.trim();
            const token = localStorage.getItem("token");
            if (!content) {
                alert("ÎåìÍ∏Ä ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî!");
                if (submitButton) submitButton.disabled = false;
                return;
            }
            const urlParams = new URLSearchParams(window.location.search);
            const feedUID = urlParams.get('id');
            const headers = { "Content-Type": "application/json" };

            if (token) {
                headers["Authorization"] = `Bearer ${token}`;
            }
            fetch(`/search/view/vote/comment/id?feedUID=${encodeURIComponent(feedUID)}`, {
                method: "POST",
                headers: headers,
                body: JSON.stringify({
                    content: content,
                    username: username,
                }),
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("ÎåìÍ∏Ä Ï†ÄÏû• Ïã§Ìå®: " + response.status);
                    }
                    return response.json();
                })
                .then((data) => {
                    console.log(data);
                    const redirectUrl = data.redirectUrl;
                    if (redirectUrl) {
                        setTimeout(() => {
                            window.location.href = redirectUrl;
                        }, 500);
                    } else {
                        console.error("Î¶¨Îã§Ïù¥Î†âÌä∏ URLÏù¥ ÏóÜÏäµÎãàÎã§.");
                    }
                })
                .catch((error) => {
                    console.error("ÎåìÍ∏Ä Ï†ÄÏû• Ï§ë Ïò§Î•ò Î∞úÏÉù:", error);
                    alert("ÎåìÍ∏Ä Ï†ÄÏû• Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
                })
                .finally(() => {
                    if (submitButton) submitButton.disabled = false;
                });
        }, 1000);
    }
    function renderReplies(replyList) {
        if (!replyList || replyList.length === 0) {
            return "";
        }
        let html = `<div class="mt-2">`;
        replyList.forEach((rp) => {
            let rank = topWriters[rp.username] || 0;
            let badge = rank === 1 ? "ü•á" : rank === 2 ? "ü•à" : rank === 3 ? "ü•â" : rank >= 4 && rank <= 5 ? "üî•" : "";
            html += `
          <div class="border-start ps-3 mb-2" style="font-size:0.9rem;">
            <strong>${badge}${rp.username}</strong>
            <small class="text-muted ms-2">${formatDate(rp.createdAt)}</small>
            <div>${rp.content}</div>
          </div>
        `;
        });
        html += `</div>`;
        return html;
    }
    function initializeCommentEvents(feedId) {
        document.querySelectorAll(".edit-comment-btn").forEach((btn) => {
            btn.addEventListener("click", function () {
                const commentId = this.getAttribute("data-comment-id");
                showEditCommentForm(commentId);
            });
        });
        document.querySelectorAll(".delete-comment-btn").forEach(btn => {
            btn.addEventListener("click", function () {
                const commentId = this.getAttribute("data-comment-id");
                deleteComment(feedId, commentId);
            });
        });
        document.querySelectorAll(".reply-toggle").forEach(btn => {
            btn.addEventListener("click", function () {
                const token = localStorage.getItem("token");
                if (!token) {
                    alert("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.");
                    return;
                }
                const commentId = this.getAttribute("data-comment-id");
                const replyForm = document.getElementById(`reply-form-${commentId}`);
                if (!replyForm) return;
                replyForm.style.display = (replyForm.style.display === "none" || replyForm.style.display === "")
                    ? "block" : "none";
            });
        });
        document.querySelectorAll(".submit-reply-btn").forEach((btn) => {
            feedId=getFeedIdFromURL()
            btn.addEventListener("click", function () {
                const commentId = this.getAttribute("data-comment-id");
                const replyContent = document.querySelector(
                    `#reply-form-${commentId} textarea`
                ).value.trim();

                if (!replyContent) {
                    alert("ÎãµÍ∏Ä ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
                    return;
                }
                submitReply(feedId, commentId, replyContent);
            });
        });
        function submitReply(feedId,commentId, replyContent) {
            const token = localStorage.getItem("token");
            const username = localStorage.getItem("username") || "ÏùµÎ™Ö";
            fetch('/search/view/vote/reply/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem("token")}`
                },
                body: JSON.stringify({
                    commentUID: commentId,
                    feedUID: feedId,
                    content: replyContent,
                    username: username,
                }),
            })
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.text();
                })
                .then(redirectUrl => {
                    setTimeout(() => {
                        window.location.href = redirectUrl;
                    }, 1000);
                })
                .catch(error => {
                    console.error('ÎãµÍ∏Ä Ï†ÄÏû• Ï§ë Ïò§Î•ò Î∞úÏÉù:', error);
                });
        }
    }
    function deleteComment(feedId, commentId) {
        if (!confirm("Ï†ïÎßêÎ°ú Ïù¥ ÎåìÍ∏ÄÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
            return;
        }
        fetch(`/search/view/comment/delete?id=${commentId}&feedUID=${feedId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("ÎåìÍ∏Ä ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
                }
                return response.json();
            })
            .then(() => {
                alert("ÎåìÍ∏ÄÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.");
                window.location.reload();
            })
            .catch(error => {
                console.error("ÎåìÍ∏Ä ÏÇ≠Ï†ú Ï§ë Ïò§Î•ò:", error);
                alert("ÎåìÍ∏Ä ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
            });
    }
    function getFeedIdFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get("id");
    }
    function showEditCommentForm(commentId) {
        fetch(`/comment/update/get?commentUID=${commentId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to fetch comment details");
                }
                return response.json();
            })
            .then(data => {

                const targetRow = document.getElementById(`comment-${commentId}`);
                if (!targetRow) {
                    console.error(`Error: Target row #comment-${commentId} not found.`);
                    return;
                }

                const existingForm = document.getElementById(`edit-comment-form-${commentId}`);
                if (existingForm) {
                    existingForm.remove();
                }

                console.log(`Found comment section container: #commentSection`);
                const editFormHtml = `
        <div id="edit-comment-form-${commentId}" class="mt-2 p-3 border rounded" style="background-color: #f9f9f9;">
          <textarea id="edit-comment-content-${commentId}" class="form-control mb-2"  rows="4" >${data.content}</textarea>
          <div class="text-end">
            <button id="save-comment-btn-${commentId}" class="btn btn-primary btn-sm me-2" data-comment-id="${data.commentUID}"data-feed-id="${data.feedUID}" >
              Save
            </button>
            <button id="cancel-edit-btn-${commentId}" class="btn btn-secondary btn-sm">
              Cancel
            </button>
          </div>
        </div>
      `;

                targetRow.insertAdjacentHTML("beforeend", editFormHtml);

                document
                    .getElementById(`save-comment-btn-${commentId}`)
                    .addEventListener("click", saveEditedComment);

                document
                    .getElementById(`cancel-edit-btn-${commentId}`)
                    .addEventListener("click", () => {
                        document.getElementById(`edit-comment-form-${commentId}`).remove();
                    });
            })
            .catch(error => {
                console.error("Error fetching comment details:", error);
                alert("Failed to fetch comment details");
            });
    }
    function saveEditedComment(event) {
        const button = event.target;
        const commentId = button.getAttribute("data-comment-id");
        const feedId = getFeedIdFromURL();
        const updatedContent = document.getElementById(`edit-comment-content-${commentId}`).value;

        setTimeout(() => {
            fetch(`/comment/update/save`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    commentUID: commentId,
                    feedUID: feedId,
                    content: updatedContent,
                }),
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Failed to save comment");
                    }
                    return response.json();
                })
                .then(data => {
                    const redirectUrl = data.redirectUrl;
                    const commentContentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
                    if (commentContentElement) {
                        commentContentElement.innerText = data.updatedContent;
                    } else {
                        console.error(`Error: Element #comment-content-${commentId} not found.`);
                    }
                    document.getElementById(`edit-comment-form-${commentId}`).remove();
                    window.location.href = redirectUrl;
                })
                .catch(error => {
                    console.error("Error saving comment:", error);
                    alert("Failed to save the comment");
                });
        }, 1000);
    }
</script>
</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>
</html>
