<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ìê²©ì¦ ìº˜ë¦°ë”</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: #f8f9fa;
    }
    .container {
      max-width: 900px;
      margin: 30px auto;
    }
    h1 {
      margin-bottom: 30px;
    }
    /* ë“œë¡­ë‹¤ìš´ ë²„íŠ¼ë“¤ì„ í•œ ì¤„ì— ë°°ì¹˜ */
    .dropdown-group {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }
    /* ëŒ€ë¶„ë¥˜ ë²„íŠ¼ í¬ê¸° í‚¤ìš°ê¸° */
    .custom-category-btn {
      flex: 1;
      height: 55px; /* ë†’ì´ ì¦ê°€ */
      font-size: 1.3rem; /* í°íŠ¸ ì‚¬ì´ì¦ˆ ì¦ê°€ */
      text-align: left;
      border: 1px solid #ced4da;
      background-color: white;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .custom-dropdown-menu {
      max-height: 250px;
      overflow-y: auto;
      width: 100%;
    }
    #calendar-container {
      display: none;
      margin-top: 20px;
    }
    #calendar {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    #studyTipFloatBtn {
      display: none;
      position: fixed;
      top: 50%;
      right: 0;
      transform: translateY(-50%);
      width: 40px;
      height: 80px;
      background-color: #007bff;
      color: #fff;
      border-radius: 8px 0 0 8px;
      align-items: center;
      justify-content: center;
      writing-mode: vertical-rl;
      text-orientation: mixed;
      font-size: 0.9rem;
      cursor: pointer;
      z-index: 3000;
    }

    #studyTipPanel {
      display:  none;
      position: fixed;
      top: 0;
      right: -400px; /* í™”ë©´ ë°– */
      width: 1000px;
      height: 100vh;
      background-color: #f8f9fa;
      box-shadow: -2px 0 8px rgba(0,0,0,0.2);
      transition: right 0.3s;
      z-index: 2999;
      padding: 10px;
      overflow-y: auto;
    }

    #closeTipPanel {
      margin-bottom: 10px;
    }
    #studyTipFloatBtn {
      z-index: 3000;
    }


  </style>
</head>
<body>

<div class="container">
  <h1 class="text-center text-primary">ğŸ“… ìê²©ì¦ ìº˜ë¦°ë”</h1>

  <!-- ë“œë¡­ë‹¤ìš´ ê·¸ë£¹: ëŒ€ë¶„ë¥˜, ì¤‘ë¶„ë¥˜, ì†Œë¶„ë¥˜ -->
  <div class="dropdown-group">
    <!-- ëŒ€ë¶„ë¥˜ -->
    <div class="dropdown">
      <button class="btn btn-light dropdown-toggle custom-category-btn" type="button" id="majorCategoryBtn" data-bs-toggle="dropdown">
        ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”
      </button>
      <ul class="dropdown-menu custom-dropdown-menu" id="majorCategoryList" aria-labelledby="majorCategoryBtn">
        <li><a class="dropdown-item" href="#" data-value="í™˜ê²½.ì—ë„ˆì§€">í™˜ê²½Â·ì—ë„ˆì§€ (ì˜ˆ: ëŒ€ê¸°í™˜ê²½ê¸°ì‚¬, ìˆ˜ì§ˆí™˜ê²½ê¸°ì‚¬)</a></li>
        <li><a class="dropdown-item" href="#" data-value="í™”í•™">í™”í•™ (ì˜ˆ: í™”ê³µê¸°ì‚¬, ìœ„í—˜ë¬¼ì‚°ì—…ê¸°ì‚¬)</a></li>
        <li><a class="dropdown-item" href="#" data-value="ì •ë³´í†µì‹ ">ì •ë³´í†µì‹  (ì˜ˆ: ì •ë³´ì²˜ë¦¬ê¸°ì‚¬, ë„¤íŠ¸ì›Œí¬ê´€ë¦¬ì‚¬)</a></li>
        <li><a class="dropdown-item" href="#" data-value="ì „ê¸°.ì „ì">ì „ê¸°Â·ì „ì (ì˜ˆ: ì „ê¸°ê¸°ì‚¬, ì „ìê¸°ê¸°ê¸°ëŠ¥ì‚¬)</a></li>
        <li><a class="dropdown-item" href="#" data-value="ì¬ë£Œ">ì¬ë£Œ (ì˜ˆ: ì¬ë£Œì¡°ì§í‰ê°€ê¸°ì‚¬, ê¸ˆì†ì¬ë£Œê¸°ì‚¬)</a></li>
        <li><a class="dropdown-item" href="#" data-value="ì´ìš©.ìˆ™ë°•.ì—¬í–‰.ì˜¤ë½.ìŠ¤í¬ì¸ ">ì´ìš©Â·ìˆ™ë°•Â·ì—¬í–‰Â·ì˜¤ë½Â·ìŠ¤í¬ì¸  (ì˜ˆ: í˜¸í…”ì„œë¹„ìŠ¤ì‚¬, êµ­ë‚´ì—¬í–‰ì•ˆë‚´ì‚¬)</a></li>
        <li><a class="dropdown-item" href="#" data-value="ì˜ì—….íŒë§¤">ì˜ì—…Â·íŒë§¤ (ì˜ˆ: ìœ í†µê´€ë¦¬ì‚¬, íŒë§¤ê´€ë¦¬ì‚¬)</a></li>
        <li><a class="dropdown-item" href="#" data-value="ì•ˆì „ê´€ë¦¬">ì•ˆì „ê´€ë¦¬ (ì˜ˆ: ì‚°ì—…ì•ˆì „ê¸°ì‚¬, ê±´ì„¤ì•ˆì „ê¸°ì‚¬)</a></li>
        <li><a class="dropdown-item" href="#" data-value="ì‹í’ˆ.ê°€ê³µ">ì‹í’ˆÂ·ê°€ê³µ (ì˜ˆ: ì‹í’ˆê¸°ì‚¬, ì œë¹µê¸°ëŠ¥ì‚¬)</a></li>
        <li><a class="dropdown-item" href="#" data-value="ì‚¬íšŒë³µì§€.ì¢…êµ">ì‚¬íšŒë³µì§€Â·ì¢…êµ (ì˜ˆ: ì‚¬íšŒë³µì§€ì‚¬, ì²­ì†Œë…„ì§€ë„ì‚¬)</a></li>
        <li><a class="dropdown-item" href="#" data-value="ë³´ê±´.ì˜ë£Œ">ë³´ê±´Â·ì˜ë£Œ (ì˜ˆ: ì„ìƒë³‘ë¦¬ì‚¬, ì‘ê¸‰êµ¬ì¡°ì‚¬)</a></li>
        <li><a class="dropdown-item" href="#" data-value="ë†ë¦¼ì–´ì—…">ë†ë¦¼ì–´ì—… (ì˜ˆ: ì¡°ê²½ê¸°ëŠ¥ì‚¬, ë†ì‚°ë¬¼í’ˆì§ˆê´€ë¦¬ì‚¬)</a></li>
        <li><a class="dropdown-item" href="#" data-value="ê¸°ê³„">ê¸°ê³„ (ì˜ˆ: ê¸°ê³„ì„¤ê³„ì‚°ì—…ê¸°ì‚¬, ìƒì‚°ìë™í™”ì‚°ì—…ê¸°ì‚¬)</a></li>
        <li><a class="dropdown-item" href="#" data-value="ê²½ì˜.íšŒê³„.ì‚¬ë¬´">ê²½ì˜Â·íšŒê³„Â·ì‚¬ë¬´ (ì˜ˆ: ê³µì¸íšŒê³„ì‚¬, ì„¸ë¬´ì‚¬)</a></li>
        <li><a class="dropdown-item" href="#" data-value="ê±´ì„¤">ê±´ì„¤ (ì˜ˆ: ê±´ì¶•ê¸°ì‚¬, í† ëª©ê¸°ì‚¬)</a></li>
        <li><a class="dropdown-item" href="#" data-value="ì˜ì–´">ì–´í•™ (ì˜ˆ: í† ìµ, ì˜¤í”½)</a></li>
      </ul>
    </div>

    <!-- ì¤‘ë¶„ë¥˜ -->
    <div id="middleCategoryContainer" class="dropdown">
      <button class="btn btn-light dropdown-toggle custom-category-btn" type="button" id="middleCategoryBtn" data-bs-toggle="dropdown" disabled>
        ì¤‘ë¶„ë¥˜ ì„ íƒ
      </button>
      <ul class="dropdown-menu custom-dropdown-menu" id="middleCategoryList"></ul>
    </div>

    <!-- ì†Œë¶„ë¥˜ -->
    <div class="dropdown">
      <button class="btn btn-light dropdown-toggle custom-category-btn" type="button" id="subCategoryBtn" data-bs-toggle="dropdown" disabled>
        ìê²©ì¦ ì„ íƒ
      </button>
      <ul class="dropdown-menu custom-dropdown-menu" id="subCategoryList"></ul>
    </div>
  </div>

  <input type="hidden" id="majorCategory" name="majorCategory">
  <input type="hidden" id="middleCategory" name="middleCategory">
  <input type="hidden" id="subCategory" name="subCategory">

  <div id="calendar-container">
    <div id="calendar"></div>
  </div>
</div>
<!-- ì†Œë¶„ë¥˜ ì„ íƒ ì „ì—” display: none; ì²˜ë¦¬ -->
<!-- ê³µë¶€íŒ ë²„íŠ¼ (ì˜¤ë¥¸ìª½ ì¤‘ì•™) -->
<div id="studyTipFloatBtn">íŒ</div>

<!-- ìŠ¬ë¼ì´ë“œ íŒ¨ë„ (ê¸°ë³¸ ìˆ¨ê¹€: right -400px) -->
<div id="studyTipPanel">
  <button id="closeTipPanel" class="btn btn-sm btn-secondary">ë‹«ê¸°</button>
  <!-- ì•„ì½”ë””ì–¸ -->
  <div class="accordion mt-3" id="studyTipAccordion">
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTips">
          ê³µë¶€ íŒ ëª©ë¡
        </button>
      </h2>
      <div id="collapseTips" class="accordion-collapse collapse">
        <div class="accordion-body" id="studyTipList"></div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const floatBtn = document.getElementById("studyTipFloatBtn");
    const studyTipPanel = document.getElementById("studyTipPanel");
    const closeBtn = document.getElementById("closeTipPanel");

    // ê³µë¶€ íŒ ë²„íŠ¼ -> íŒ¨ë„ ì—´ê¸°
    floatBtn.addEventListener("click", () => {
      studyTipPanel.style.display = "block";
      // íŒ¨ë„ì´ ì•„ì˜ˆ ìˆ¨ê²¨ì ¸ ìˆì—ˆë‹¤ë©´, ë³´ì´ë„ë¡
      setTimeout(() => {
        studyTipPanel.style.right = "0";
      }, 0);
    });

    // ë‹«ê¸° ë²„íŠ¼ -> íŒ¨ë„ ë‹«ê¸°
    closeBtn.addEventListener("click", () => {
      studyTipPanel.style.right = "-400px";
      setTimeout(() => {
        studyTipPanel.style.display = "none";
      }, 300); // ì• ë‹ˆë©”ì´ì…˜ í›„ì— display none
    });
  });
  let calendar;
  document.addEventListener("DOMContentLoaded", function () {
    const categoryMapping = {
      "ê¸°ê³„": ["ê¸°ê³„ì¥ë¹„ì„¤ë¹„.ì„¤ì¹˜", "ê¸°ê³„ì œì‘", "ê¸ˆí˜•.ê³µì‘ê¸°ê³„", "ìë™ì°¨", "ì² ë„"],
      "ê±´ì„¤": ["ê±´ì¶•", "ë„ì‹œ.êµí†µ", "í† ëª©", "ì¡°ê²½", "ê±´ì„¤ë°°ê´€"],
      "ì•ˆì „ê´€ë¦¬": ["ì•ˆì „ê´€ë¦¬"],
      "ì „ê¸°.ì „ì": ["ì „ê¸°", "ì „ì"],
      "í™˜ê²½.ì—ë„ˆì§€": ["í™˜ê²½", "ì—ë„ˆì§€.ê¸°ìƒ"],
      "ì •ë³´í†µì‹ ": ["ì •ë³´ê¸°ìˆ "],
      "ì¬ë£Œ": ["ìš©ì ‘", "ê¸ˆì†.ì¬ë£Œ", "ë‹¨ì¡°.ì£¼ì¡°"],
      "ì‹í’ˆ.ê°€ê³µ": ["ì‹í’ˆ", "ì œê³¼.ì œë¹µ"],
      "ê²½ì˜.íšŒê³„.ì‚¬ë¬´": ["ìƒì‚°ê´€ë¦¬", "ê²½ì˜"],
      "ì´ìš©.ìˆ™ë°•.ì—¬í–‰.ì˜¤ë½.ìŠ¤í¬ì¸ ": ["ì´ìš©.ë¯¸ìš©", "ìˆ™ë°•.ì—¬í–‰.ì˜¤ë½.ìŠ¤í¬ì¸ "],
      "ë†ë¦¼ì–´ì—…": ["ì„ì—…", "ì–´ì—…", "ë†ì—…", "ì¶•ì‚°"],
      "ë³´ê±´.ì˜ë£Œ": ["ë³´ê±´.ì˜ë£Œ"],
      "ì‚¬íšŒë³µì§€.ì¢…êµ": ["ì‚¬íšŒë³µì§€.ì¢…êµ"],
      "ì˜ì—….íŒë§¤": ["ì˜ì—….íŒë§¤"],
      "í™”í•™": ["í™”ê³µ", "ìœ„í—˜ë¬¼"],
      "ì˜ì–´": ["í† ìµ"]
    };

    const majorCategoryBtn = document.getElementById("majorCategoryBtn");
    const majorCategoryList = document.querySelectorAll("#majorCategoryList .dropdown-item");
    const middleCategoryContainer = document.getElementById("middleCategoryContainer");
    const middleCategoryBtn = document.getElementById("middleCategoryBtn");
    const middleCategoryList = document.getElementById("middleCategoryList");
    const subCategoryContainer = document.getElementById("subCategoryContainer");
    const subCategoryBtn = document.getElementById("subCategoryBtn");
    const subCategoryList = document.getElementById("subCategoryList");


    // ëŒ€ë¶„ë¥˜ ì„ íƒ
    majorCategoryList.forEach(item => {
      item.addEventListener("click", function (event) {
        event.preventDefault();
        const selectedMajor = this.getAttribute("data-value");
        majorCategoryBtn.innerText = this.innerText;
        document.getElementById("majorCategory").value = selectedMajor;

        middleCategoryList.innerHTML = "";
        // subCategoryList.innerHTML = "";
        // subCategoryContainer.style.display = "none"; // âœ… ì˜¤ë¥˜ ë°©ì§€
        // subCategoryBtn.disabled = true;

        if (categoryMapping[selectedMajor]) {

          middleCategoryContainer.style.display = "block"; // âœ… ì˜¤ë¥˜ ë°©ì§€ ì½”ë“œ ì¶”ê°€
          middleCategoryBtn.disabled = false;
          middleCategoryBtn.innerText = "ì¤‘ë¶„ë¥˜ë¥¼ ì„ íƒí•˜ì„¸ìš”";

          categoryMapping[selectedMajor].forEach(sub => {
            const li = document.createElement("li");
            const a = document.createElement("a");
            a.className = "dropdown-item";
            a.href = "#";
            a.textContent = sub;
            a.setAttribute("data-value", sub);
            li.appendChild(a);
            middleCategoryList.appendChild(li);

            a.addEventListener("click", function (event) {
              event.preventDefault();
              middleCategoryBtn.innerText = this.innerText;
              document.getElementById("middleCategory").value = this.getAttribute("data-value");


              fetchSubCategories(selectedMajor, this.getAttribute("data-value"));
            });
          });
        } else {
          middleCategoryContainer.style.display = "none";
        }
      });
    });

    // FullCalendar ì´ˆê¸°í™”
    var calendarEl = document.getElementById("calendar");
    var calendarContainer = document.getElementById("calendar-container");

    calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "dayGridMonth",
      locale: "ko",
      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "dayGridMonth,timeGridWeek,timeGridDay"
      },
      eventLimit: true,
      dayMaxEventRows: 3,
      moreLinkText: "ë”ë³´ê¸°",
      height: "auto",
      events: [] // ì´ˆê¸° ì´ë²¤íŠ¸ ë¹ˆ ë°°ì—´
    });
    calendar.render();
    // ìº˜ë¦°ë”ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€
  });

  // ì†Œë¶„ë¥˜ API í˜¸ì¶œ
  function fetchSubCategories(mainCategory, subCategory) {
    const token = localStorage.getItem("token");
    fetch(`/certificate/category/${mainCategory}/${subCategory}`, {
      method: "GET",
      headers: {
        "Authorization": "Bearer " + token
      }
    })
            .then(response => response.json())
            .then(data => {
              const subCategoryList = document.getElementById("subCategoryList");
              // const subCategoryContainer = document.getElementById("subCategoryContainer");
              const subCategoryBtn = document.getElementById("subCategoryBtn");
              subCategoryList.innerHTML = "";
              if (data.certSchedule && data.certSchedule.length > 0) {
                // subCategoryContainer.style.display = "block";
                subCategoryBtn.disabled = false;
                subCategoryBtn.innerText = "ìê²©ì¦ì„ ì„ íƒí•˜ì„¸ìš”";

                // data.certSchedule: List<String>
                data.certSchedule.forEach(certName => {
                  const li = document.createElement("li");
                  const a = document.createElement("a");
                  a.className = "dropdown-item";
                  a.href = "#";
                  a.textContent = certName;
                  a.setAttribute("data-value", certName);
                  li.appendChild(a);
                  subCategoryList.appendChild(li);

                  a.addEventListener("click", function (event) {
                    event.preventDefault();
                    subCategoryBtn.innerText = this.innerText;
                    document.getElementById("subCategory").value = this.getAttribute("data-value");
                    fetchCertificationSchedules(this.getAttribute("data-value"));
                    onSelectSubCategory(this.getAttribute("data-value"));
                  });
                });
              }
            })
            .catch(error => console.error("ì†Œë¶„ë¥˜ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error));
  }

  // ìê²©ì¦ ì¼ì • ìº˜ë¦°ë” ì´ë²¤íŠ¸ ë¡œë“œ í•¨ìˆ˜
  function fetchCertificationSchedules(category) {
    const token = localStorage.getItem("token");
    fetch(`/certificate/schedule/${category}`, {
      method: "GET",
      headers: {
        "Authorization": "Bearer " + token
      }
    })
            .then(response => response.json())
            .then(data => {
              if (data.certSchedule) {
                // API ì‘ë‹µ ë°ì´í„°ê°€ List<Cert>ì¸ ê²½ìš°
                calendar.removeAllEvents();
                const events = data.certSchedule.flatMap(cert => [
                  { title: `[í•„ê¸° ì›ì„œì ‘ìˆ˜] ${cert.name} - ${cert.examRound}`, start: cert.writtenRegStart, color: "#007bff" },
                  { title: `[í•„ê¸° ì‹œí—˜] ${cert.name} - ${cert.examRound}`, start: cert.writtenExamStart, color: "#ff6b6b" },
                  { title: `[í•„ê¸° í•©ê²©ë°œí‘œ] ${cert.name} - ${cert.examRound}`, start: cert.writtenPassDate, color: "#ffc107" },
                  { title: `[ì‹¤ê¸° ì›ì„œì ‘ìˆ˜] ${cert.name} - ${cert.examRound}`, start: cert.practicalRegStart, color: "#17a2b8" },
                  { title: `[ì‹¤ê¸° ì‹œí—˜] ${cert.name} - ${cert.examRound}`, start: cert.practicalExamStart, color: "#28a745" },
                  { title: `[ì‹¤ê¸° í•©ê²©ë°œí‘œ] ${cert.name} - ${cert.examRound}`, start: cert.practicalPassStart, color: "#ff851b" }
                ]);
                document.getElementById("calendar-container").style.display = "block";
                calendar.addEventSource(events);
                calendar.render();
              }
            })
            .catch(error => console.error("ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:", error));
  }
  function onSelectSubCategory(keyword) {
    fetchTistoryPosts(keyword);
    const tipBtn = document.getElementById("studyTipFloatBtn");
    if (tipBtn) {
      tipBtn.style.display = "flex";
    }
  }

  function fetchTistoryPosts(keyword) {
    fetch(`/tistory/${encodeURIComponent(keyword)}`)
            .then(response => response.json())
            .then(data => {
              // data: List<TistoryPost>
              renderStudyTips(data);
            })
            .catch(error => console.error('ì˜¤ë¥˜ ë°œìƒ:', error));
  }

  function renderStudyTips(posts) {
    const container = document.getElementById('studyTipList');
    container.innerHTML = ""; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”

    if (posts.length === 0) {
      container.innerHTML = "<p>ê´€ë ¨ íŒì´ ì—†ìŠµë‹ˆë‹¤.</p>";
      return;
    }

    posts.forEach(post => {
      const card = document.createElement('div');
      card.className = 'card mb-3';

      card.innerHTML = `
        <div class="row g-0">
          <!-- ì¸ë„¤ì¼ ìˆìœ¼ë©´ ì¢Œì¸¡ì— í‘œì‹œ -->
          <div class="col-md-4 d-flex align-items-center">
            <img src="${post.thumbnailUrl || ''}" class="img-fluid rounded-start" alt="ì¸ë„¤ì¼" onerror="this.style.display='none';">
          </div>
          <div class="col-md-8">
            <div class="card-body">
              <h5 class="card-title">${post.title}</h5>
              <p class="card-text">${post.description || ''}</p>
              <p class="card-text">
                <small class="text-muted">ë¸”ë¡œê·¸: <a href="${post.blogUrl}" target="_blank">${post.blogName}</a></small><br>
                <small class="text-muted">ì‘ì„±ì¼: ${post.date || ''}</small>
              </p>
              <a href="${post.postUrl}" target="_blank" class="btn btn-primary">ì›ë¬¸ ë³´ê¸°</a>
            </div>
          </div>
        </div>
      `;
      container.appendChild(card);
    });
  }

</script>

</body>
</html>
